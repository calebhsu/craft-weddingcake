<craft>
    <parameter name="tiers" type="int" default="1"/>
    
    <!-- Single Cake Layer -->
    <craft name="layer">
        <parameter name="width" type="int" default="30"/>
        <parameter name="height" type="int" default="10"/>
        <parameter name="beadNumber" type="int" default="10"/>
        
        <group>
            <!-- Base -->
            <script type="text/openjscad">
                function main() {
                    // handles minimum values
                    if (params.height < 1) { params.height = 1; }
        
                    if (params.tiers < 1) { params.tiers = 1; }
                    
                    // handles maximum values
                    if (params.beadNumber > 70) { params.beadNumber = 70; }
    
                    return cylinder({
                        r: params.width / 2,
                        h: params.height,
                        center: [true, true, false]
                    }).translate([1, 1, 0]);
                }
            </script>
            
            <!-- Fill -->
            <script type="text/openjscad">
                function main() {
                    return cylinder({
                            r: (params.width / 2) - 1, 
                            h: 1
                        }).translate([1, 1, params.height]);
                }
            </script>
            
            <!-- Round -->
            <script type="text/openjscad">
                function main() {
                    return torus({
                        ri: 1,
                        ro: (params.width / 2) - 1
                    }).translate([1, 1, params.height]);
                }
            </script>
            
            <!-- Border -->
            <script type="text/craftml">
                function main() {
                    var beads = []
                    var r = (params.width / 2), n = params.beadNumber, theta = 0
                    var delta = 2 * Math.PI / n
                    for (var i = 0; i < n; i++) {
                        var x = r * Math.cos(theta)
                        var y = r * Math.sin(theta)
                        beads.push('<sphere x="' + x + '" y="' + y + '"z="0.1" radius="1"/>')
                        theta = theta + delta
                    }
                    return beads.join('\n')
                }
            </script>
        </group>
        
    </craft>
    
    <!-- Stacks Multiple Tiers -->
    <script type="text/craftml">
        function main() {
            var tierSize;
            var xml = '<stack>'

            for (var i = 1; i < params.tiers; i++) {
                tierSize = (1 / (params.tiers - 0.3)) * i 
                xml += '<scale factor="' + tierSize + '">'
                xml += '<layer></layer></scale>'
            } 
            xml += '<layer></layer></stack>'
            
            return xml
        }
    </script>
    
</craft>